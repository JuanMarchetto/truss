<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truss Playground - GitHub Actions Workflow Validator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 12px 24px;
            background: #16213e;
            border-bottom: 1px solid #0f3460;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            font-size: 1.2rem;
            color: #e94560;
        }
        header h1 span { color: #e0e0e0; font-weight: 300; }
        .version { font-size: 0.8rem; color: #888; }
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-pane, .results-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .editor-pane { border-right: 1px solid #0f3460; }
        .pane-header {
            padding: 8px 16px;
            background: #16213e;
            font-size: 0.85rem;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .CodeMirror {
            flex: 1;
            height: auto !important;
            font-size: 14px;
        }
        #results {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .diagnostic {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid;
        }
        .diagnostic.error {
            background: rgba(233, 69, 96, 0.1);
            border-color: #e94560;
        }
        .diagnostic.warning {
            background: rgba(255, 183, 77, 0.1);
            border-color: #ffb74d;
        }
        .diagnostic.info {
            background: rgba(100, 181, 246, 0.1);
            border-color: #64b5f6;
        }
        .diagnostic .severity {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .diagnostic.error .severity { color: #e94560; }
        .diagnostic.warning .severity { color: #ffb74d; }
        .diagnostic.info .severity { color: #64b5f6; }
        .diagnostic .message { margin-top: 2px; }
        .diagnostic .span { color: #888; font-size: 0.8rem; }
        .valid {
            color: #4caf50;
            padding: 24px;
            text-align: center;
            font-size: 1.1rem;
        }
        .status-bar {
            padding: 6px 16px;
            background: #16213e;
            border-top: 1px solid #0f3460;
            font-size: 0.8rem;
            color: #888;
            display: flex;
            justify-content: space-between;
        }
        .loading { color: #ffb74d; }
    </style>
</head>
<body>
    <header>
        <h1>Truss <span>Playground</span></h1>
        <span class="version" id="version">Loading WASM...</span>
    </header>
    <div class="main">
        <div class="editor-pane">
            <div class="pane-header">Workflow YAML</div>
            <textarea id="editor">name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: echo "Hello, world!"
</textarea>
        </div>
        <div class="results-pane">
            <div class="pane-header">Diagnostics</div>
            <div id="results" class="loading">Initializing Truss engine...</div>
        </div>
    </div>
    <div class="status-bar">
        <span id="diagnostic-count">-</span>
        <span id="timing">-</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script>
    <script type="module">
        import init, { validate, version } from './pkg/truss_wasm.js';

        let editor;
        let debounceTimer;

        async function main() {
            // Initialize WASM module
            try {
                await init();
                document.getElementById('version').textContent = `v${version()}`;
            } catch (e) {
                document.getElementById('results').innerHTML =
                    '<div class="diagnostic error">' +
                    '<div class="severity">Error</div>' +
                    '<div class="message">Failed to load WASM module. Build with: wasm-pack build crates/truss-wasm --target web</div>' +
                    '</div>';
                document.getElementById('version').textContent = 'WASM not loaded';
                return;
            }

            // Initialize CodeMirror
            editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                mode: 'yaml',
                theme: 'dracula',
                lineNumbers: true,
                tabSize: 2,
                indentWithTabs: false,
                lineWrapping: true,
            });

            // Live validation on change
            editor.on('change', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(runValidation, 150);
            });

            // Initial validation
            runValidation();
        }

        function runValidation() {
            const source = editor.getValue();
            const start = performance.now();

            try {
                const jsonResult = validate(source);
                const elapsed = (performance.now() - start).toFixed(1);
                const result = JSON.parse(jsonResult);

                renderResults(result.diagnostics);
                document.getElementById('timing').textContent = `${elapsed}ms`;
            } catch (e) {
                document.getElementById('results').innerHTML =
                    `<div class="diagnostic error">
                        <div class="severity">Error</div>
                        <div class="message">${e.message}</div>
                    </div>`;
            }
        }

        function renderResults(diagnostics) {
            const container = document.getElementById('results');
            const countEl = document.getElementById('diagnostic-count');

            if (!diagnostics || diagnostics.length === 0) {
                container.innerHTML = '<div class="valid">No issues found</div>';
                countEl.textContent = 'No issues';
                return;
            }

            const errors = diagnostics.filter(d => d.severity === 'error').length;
            const warnings = diagnostics.filter(d => d.severity === 'warning').length;
            const infos = diagnostics.filter(d => d.severity === 'info').length;

            const parts = [];
            if (errors) parts.push(`${errors} error${errors > 1 ? 's' : ''}`);
            if (warnings) parts.push(`${warnings} warning${warnings > 1 ? 's' : ''}`);
            if (infos) parts.push(`${infos} info`);
            countEl.textContent = parts.join(', ');

            container.innerHTML = diagnostics.map(d => `
                <div class="diagnostic ${d.severity}">
                    <div class="severity">${d.severity}</div>
                    <div class="message">${escapeHtml(d.message)}</div>
                    <div class="span">bytes ${d.span.start}..${d.span.end}</div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        main();
    </script>
</body>
</html>
